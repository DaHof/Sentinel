<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: system-ui, sans-serif; padding: 2rem; background-color: #0f172a;}
      header { display:flex; justify-content: space-between; align-items:center; }
      .app-header { background:#0f172a; color:#fff; padding:.6rem 1rem; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,.15); }
      .app-header a { color:#fff; text-decoration:none; }
      .app-header a:hover { text-decoration:underline; }
      .brand { display:flex; align-items:center; gap:.6rem; }
      .logo { height: 28px; width:auto; display:block; }
      .card { max-width: 1100px; margin: 1rem auto; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background-color: whitesmoke; }
      label { display:block; margin-top: .5rem; }
      input { padding: .4rem; }
      button { padding: .5rem 1rem; margin-top: .5rem; }
      .muted { color: #666; font-size: .9rem;}
      .row { display:flex; gap: 2rem; }
      .col { flex: 1; }
      /* Bootstrap-like alert styles for flash messages */
      .alert { padding:.6rem 1rem; border-radius:6px; margin:.5rem 0; border:1px solid transparent; }
      .alert-success { color:#0f5132; background-color:#d1e7dd; border-color:#badbcc; }
      .alert-danger { color:#842029; background-color:#f8d7da; border-color:#f5c2c7; }
      .alert-warning { color:#664d03; background-color:#fff3cd; border-color:#ffecb5; }
      .alert-info { color:#055160; background-color:#cff4fc; border-color:#b6effb; }
      .error { color: #b00; }
      .dimmed { opacity: .55; filter: grayscale(0.4); }
      .disabled { pointer-events: none; }
      .inline { display: inline-flex; align-items: center; gap: .5rem; }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <img src="{{ url_for('static', filename='Sentinel.webp') }}" class="logo" alt="Logo"/>
        <h2 style="margin:0">Plugin Settings</h2>
      </div>
      <nav>
        <a href="/">Dashboard</a>
        &nbsp;|&nbsp;
        <a href="/settings">Settings</a>
        &nbsp;|&nbsp;
        <a href="/logs">Logs</a>
        &nbsp;|&nbsp;
        <a href="/logout">Logout</a>
      </nav>
    </header>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% set cls = 'alert-info' %}
          {% if category in ['success','ok'] %}{% set cls = 'alert-success' %}
          {% elif category in ['error','danger'] %}{% set cls = 'alert-danger' %}
          {% elif category in ['warning','warn'] %}{% set cls = 'alert-warning' %}
          {% endif %}
          <div role="alert" class="alert {{ cls }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <script>
      (function() {
        var timeoutMs = 4000;
        document.querySelectorAll('.alert').forEach(function(el){
          setTimeout(function(){
            el.style.transition = 'opacity 0.6s ease';
            el.style.opacity = '0';
            setTimeout(function(){ if (el && el.parentNode) el.parentNode.removeChild(el); }, 650);
          }, timeoutMs);
        });
      })();
    </script>

    <div class="card">
      <h3>SNDS</h3>
      <form class="inline" method="post" action="/plugins/snds/enable">
        <label class="inline">
          <input type="checkbox" name="plugin_enabled" {% if snds_cfg.enabled %}checked{% endif %} />
          Plugin Enabled
        </label>
        <button type="submit">Save</button>
      </form>
      <div class="row">
        <div class="col {% if not snds_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Schedule</strong>
          {% if not has_key %}
            <div class="error">SNDS_KEY is not set. Ingest will fail until configured.</div>
          {% endif %}
          <form method="post" action="/plugins/snds/schedule">
            <label>Interval minutes
              <input type="number" min="1" name="interval_minutes" value="{{ snds_cfg.schedule.interval_minutes }}" />
            </label>
            <label>
              <input type="checkbox" name="enabled" {% if snds_cfg.schedule.enabled %}checked{% endif %} />
              Enabled
            </label>
            <div class="muted">
              Last run: {{ snds_job_state.get('last_run') or 'never' }}<br/>
              Next run: {{ snds_job_state.get('next_run') or 'unscheduled' }}
            </div>
            <button type="submit">Save Schedule</button>
          </form>
          <form method="post" action="/run-now">
            <button type="submit">Run now</button>
          </form>
        </div>
        <div class="col {% if not snds_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Alert Rules</strong>
          <form method="post" action="/plugins/snds/alerts">
            <label>
              <input type="checkbox" name="alerts_enabled" {% if snds_cfg.alerts.enabled %}checked{% endif %} />
              Enabled
            </label>
            <label>Complaint rate greater than (%)
              <input type="number" step="0.01" min="0" name="complaint_rate_threshold" value="{{ snds_cfg.alerts.complaint_rate_threshold }}" />
            </label>
            <label>Trap hits at least
              <input type="number" step="1" min="0" name="trap_hits_threshold" value="{{ snds_cfg.alerts.trap_hits_threshold }}" />
            </label>
            <label>Filter levels
              <div>
                <label><input type="checkbox" name="level_yellow" {% if 'YELLOW' in snds_cfg.alerts.filter_levels %}checked{% endif %}/> YELLOW</label>
              </div>
              <div>
                <label><input type="checkbox" name="level_red" {% if 'RED' in snds_cfg.alerts.filter_levels %}checked{% endif %}/> RED</label>
              </div>
            </label>
            <button type="submit">Save Alert Rules</button>
          </form>
        </div>
        <div class="col {% if not snds_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Delivery Settings</strong>
          <form method="post" action="/plugins/snds/delivery">
            <label><input type="checkbox" name="method_email" {% if snds_cfg.delivery.email.enabled %}checked{% endif %}/> Email</label>
            <label>Email recipients (comma-separated)
              <input type="text" name="email_recipients" value="{{ snds_cfg.delivery.email.recipients }}" placeholder="ops@example.com, me@example.com" />
            </label>
            <label><input type="checkbox" name="method_slack" {% if snds_cfg.delivery.slack.enabled %}checked{% endif %}/> Slack</label>
            <label>Slack webhook URL
              <input type="text" name="slack_webhook_url" value="{{ snds_cfg.delivery.slack.webhook_url }}" placeholder="https://hooks.slack.com/services/..." />
            </label>
            <label><input type="checkbox" name="method_teams" {% if snds_cfg.delivery.teams.enabled %}checked{% endif %}/> Microsoft Teams</label>
            <label>Teams webhook URL
              <input type="text" name="teams_webhook_url" value="{{ snds_cfg.delivery.teams.webhook_url }}" placeholder="https://outlook.office.com/webhook/..." />
            </label>
            <label>Message template
              <textarea name="message_template" rows="3" style="width:100%">{{ snds_cfg.delivery.message_template }}</textarea>
              <div class="muted">Fields: {ip}, {activity_start}, {activity_end}, {complaint_rate}, {trap_hits}, {filter_result}</div>
            </label>
            <button type="submit">Save Delivery</button>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>News</h3>
      <form class="inline" method="post" action="/plugins/news/enable">
        <label class="inline">
          <input type="checkbox" name="plugin_enabled" {% if news_cfg.enabled %}checked{% endif %} />
          Plugin Enabled
        </label>
        <button type="submit">Save</button>
      </form>
      <div class="row">
        <div class="col {% if not news_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Schedule</strong>
          <form method="post" action="/plugins/news/schedule">
            <label>Interval minutes
              <input type="number" min="1" name="interval_minutes" value="{{ news_cfg.schedule.interval_minutes }}" />
            </label>
            <label>
              <input type="checkbox" name="enabled" {% if news_cfg.schedule.enabled %}checked{% endif %} />
              Enabled
            </label>
            <div class="muted">
              Last run: {{ news_job_state.get('last_run') or 'never' }}<br/>
              Next run: {{ news_job_state.get('next_run') or 'unscheduled' }}
            </div>
            <div class="muted">Note: News plugin is a placeholder. No job runs yet.</div>
            <button type="submit">Save Schedule</button>
          </form>
        </div>
        <div class="col {% if not news_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Alert Rules</strong>
          <form method="post" action="/plugins/news/alerts">
            <label>
              <input type="checkbox" name="alerts_enabled" {% if news_cfg.alerts.enabled %}checked{% endif %} />
              Enabled
            </label>
            <label>Keywords (comma-separated)
              <input type="text" name="keywords" value="{{ news_cfg.alerts.keywords }}" placeholder="security, vulnerability, outage" />
            </label>
            <label>Sources (comma-separated)
              <input type="text" name="sources" value="{{ news_cfg.alerts.sources }}" placeholder="cnn.com, bbc.com" />
            </label>
            <button type="submit">Save Alert Rules</button>
          </form>
        </div>
        <div class="col {% if not news_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Delivery Settings</strong>
          <form method="post" action="/plugins/news/delivery">
            <label><input type="checkbox" name="method_email" {% if news_cfg.delivery.email.enabled %}checked{% endif %}/> Email</label>
            <label>Email recipients (comma-separated)
              <input type="text" name="email_recipients" value="{{ news_cfg.delivery.email.recipients }}" placeholder="ops@example.com, me@example.com" />
            </label>
            <label><input type="checkbox" name="method_slack" {% if news_cfg.delivery.slack.enabled %}checked{% endif %}/> Slack</label>
            <label>Slack webhook URL
              <input type="text" name="slack_webhook_url" value="{{ news_cfg.delivery.slack.webhook_url }}" placeholder="https://hooks.slack.com/services/..." />
            </label>
            <label><input type="checkbox" name="method_teams" {% if news_cfg.delivery.teams.enabled %}checked{% endif %}/> Microsoft Teams</label>
            <label>Teams webhook URL
              <input type="text" name="teams_webhook_url" value="{{ news_cfg.delivery.teams.webhook_url }}" placeholder="https://outlook.office.com/webhook/..." />
            </label>
            <label>Message template
              <textarea name="message_template" rows="3" style="width:100%">{{ news_cfg.delivery.message_template }}</textarea>
              <div class="muted">Fields (future): {title}, {url}</div>
            </label>
            <button type="submit">Save Delivery</button>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>SenderScore</h3>
      <form class="inline" method="post" action="/plugins/senderscore/enable">
        <label class="inline">
          <input type="checkbox" name="plugin_enabled" {% if ss_cfg.enabled %}checked{% endif %} />
          Plugin Enabled
        </label>
        <button type="submit">Save</button>
      </form>
      <div class="row">
        <div class="col {% if not ss_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Schedule</strong>
          <form method="post" action="/plugins/senderscore/schedule">
            <label>Interval minutes
              <input type="number" min="1" name="interval_minutes" value="{{ ss_cfg.schedule.interval_minutes }}" />
            </label>
            <label>
              <input type="checkbox" name="enabled" {% if ss_cfg.schedule.enabled %}checked{% endif %} />
              Enabled
            </label>
            <div class="muted">
              Last run: {{ ss_job_state.get('last_run') or 'never' }}<br/>
              Next run: {{ ss_job_state.get('next_run') or 'unscheduled' }}
            </div>
            <button type="submit">Save Schedule</button>
          </form>
          <form method="post" action="/plugins/senderscore/run-now">
            <button type="submit">Run now</button>
          </form>
        </div>
        <div class="col {% if not ss_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Alert Rules & Options</strong>
          <form method="post" action="/plugins/senderscore/alerts">
            <label>
              <input type="checkbox" name="alerts_enabled" {% if ss_cfg.alerts.enabled %}checked{% endif %} />
              Enabled
            </label>
            <label>Alert when score changes more than (%)
              <input type="number" step="0.1" min="0" name="change_threshold_percent" value="{{ ss_cfg.alerts.change_threshold_percent }}" />
            </label>
            <label>
              <input type="checkbox" name="notify_on_measure_change" {% if ss_cfg.alerts.notify_on_measure_change %}checked{% endif %} />
              Alert when reputation measures change
            </label>
            <label>
              <input type="checkbox" name="reputation_low_to_other" {% if ss_cfg.alerts.reputation_low_to_other %}checked{% endif %} />
              Alert if any reputation shifts from Low to higher
            </label>
            <label>Spam Traps threshold (>=)
              <input type="number" step="1" min="0" name="spam_trap_threshold" value="{{ ss_cfg.alerts.spam_trap_threshold }}" />
            </label>
            <label>Volume avg window (days)
              <input type="number" step="1" min="1" name="volume_avg_days" value="{{ ss_cfg.alerts.volume_avg_days }}" />
            </label>
            <label>Alert when volume delta vs avg exceeds (%)
              <input type="number" step="0.1" min="0" name="volume_change_threshold_percent" value="{{ ss_cfg.alerts.volume_change_threshold_percent }}" />
            </label>
            <label>IP Source</label>
            <label class="inline"><input type="radio" name="ip_source" value="snds" {% if ss_cfg.options.ip_source == 'snds' %}checked{% endif %}/> From SNDS</label>
            <label class="inline"><input type="radio" name="ip_source" value="manual" {% if ss_cfg.options.ip_source == 'manual' %}checked{% endif %}/> Manual list</label>
            <label>Manual IPs (comma/newline-separated)
              <textarea name="manual_ips" rows="4" style="width:100%">{{ ss_cfg.options.manual_ips }}</textarea>
            </label>
            <button type="submit">Save Alerts & Options</button>
          </form>
        </div>
        <div class="col {% if not ss_cfg.enabled %}dimmed disabled{% endif %}">
          <strong>Delivery Settings</strong>
          <form method="post" action="/plugins/senderscore/delivery">
            <label><input type="checkbox" name="method_email" {% if ss_cfg.delivery.email.enabled %}checked{% endif %}/> Email</label>
            <label>Email recipients (comma-separated)
              <input type="text" name="email_recipients" value="{{ ss_cfg.delivery.email.recipients }}" placeholder="ops@example.com, me@example.com" />
            </label>
            <label><input type="checkbox" name="method_slack" {% if ss_cfg.delivery.slack.enabled %}checked{% endif %}/> Slack</label>
            <label>Slack webhook URL
              <input type="text" name="slack_webhook_url" value="{{ ss_cfg.delivery.slack.webhook_url }}" placeholder="https://hooks.slack.com/services/..." />
            </label>
            <label><input type="checkbox" name="method_teams" {% if ss_cfg.delivery.teams.enabled %}checked{% endif %}/> Microsoft Teams</label>
            <label>Teams webhook URL
              <input type="text" name="teams_webhook_url" value="{{ ss_cfg.delivery.teams.webhook_url }}" placeholder="https://outlook.office.com/webhook/..." />
            </label>
            <label>Message template
              <textarea name="message_template" rows="3" style="width:100%">{{ ss_cfg.delivery.message_template }}</textarea>
              <div class="muted">Fields: {ip}, {old_score}, {new_score}, {delta_percent}, {volume}, {reason}</div>
            </label>
            <button type="submit">Save Delivery</button>
          </form>
        </div>
      </div>
    </div>

  </body>
  </html>
